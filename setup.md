# Coreographer Setup

Complete guide to setting up your multi-core RISC-V system with FuseSoC.

## Prerequisites

### Required Tools

1. **FuseSoC**
```bash
pip3 install fusesoc
```

2. **Verilator** (for simulation)
```bash
# Ubuntu/Debian
sudo apt-get install verilator

# Or build from source for latest version
git clone https://github.com/verilator/verilator
cd verilator
autoconf && ./configure && make && sudo make install
```

3. **Vivado** (for FPGA synthesis)
   - Download from Xilinx website
   - Version 2020.2 or newer recommended
   - Ensure `vivado` is in your PATH

4. **Python 3.7+**
```bash
python3 --version
pip3 install jq  # For JSON parsing in Makefile
```

5. **GTKWave** (optional, for viewing waveforms)
```bash
sudo apt-get install gtkwave
```

## Directory Structure

After setup, your repository should look like this:

```
coreographer/
â”œâ”€â”€ fusesoc.conf               # FuseSoC configuration
â”œâ”€â”€ coreographer.core          # Main FuseSoC core file
â”œâ”€â”€ Makefile                   # Build automation
â”œâ”€â”€ SETUP_GUIDE.md            # This file
â”œâ”€â”€ configs/
â”‚   â”œâ”€â”€ default.json          # Default 4-core configuration
â”‚   â”œâ”€â”€ 2core.json            # 2-core configuration (create if needed)
â”‚   â””â”€â”€ 8core.json            # 8-core configuration (create if needed)
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ gen_top.py            # Top-level generator
â”‚   â””â”€â”€ vivado/
â”‚       â”œâ”€â”€ program.tcl       # FPGA programming script
â”‚       â”œâ”€â”€ post_synth_reports.tcl
â”‚       â””â”€â”€ post_impl_reports.tcl
â”œâ”€â”€ rtl/
â”‚   â”œâ”€â”€ cores/
â”‚   â”‚   â””â”€â”€ vexriscv/
â”‚   â”‚       â””â”€â”€ VexRiscv.v    # Downloaded VexRiscv core
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ core_wrapper.v    # Wrapper around VexRiscv
â”‚   â”‚   â”œâ”€â”€ neighbor_interface.v
â”‚   â”‚   â””â”€â”€ register_file_proxy.v
â”‚   â”œâ”€â”€ scheduler/
â”‚   â”‚   â”œâ”€â”€ task_dispatcher.v
â”‚   â”‚   â”œâ”€â”€ task_queue.v
â”‚   â”‚   â”œâ”€â”€ instruction_cache.v
â”‚   â”‚   â””â”€â”€ dependency_tracker.v
â”‚   â”œâ”€â”€ interconnect/
â”‚   â”‚   â”œâ”€â”€ memory_arbiter.v
â”‚   â”‚   â”œâ”€â”€ neighbor_network.v
â”‚   â”‚   â””â”€â”€ dispatch_bus.v
â”‚   â””â”€â”€ common/
â”‚       â”œâ”€â”€ defines.vh
â”‚       â””â”€â”€ params.vh
â”œâ”€â”€ tb/
â”‚   â”œâ”€â”€ tb_top.v
â”‚   â”œâ”€â”€ tb_core_wrapper.v
â”‚   â”œâ”€â”€ tb_scheduler.v
â”‚   â””â”€â”€ test_programs/
â”‚       â””â”€â”€ test.hex
â”œâ”€â”€ constraints/
â”‚   â””â”€â”€ pynq_z2.xdc
â””â”€â”€ build/                     # Generated by FuseSoC (gitignore)
    â””â”€â”€ generated/
        â””â”€â”€ top.v              # Auto-generated top-level
```

## Step-by-Step Setup

### Step 1: Initialize FuseSoC

```bash
# Initialize the build system
make setup
```

This creates the directory structure and checks for dependencies.

### Step 2: Get VexRiscv Core

You have two options:

**Option A: Use Pre-generated Verilog (Recommended)**

1. Download pre-generated VexRiscv from the releases:
```bash
cd rtl/cores/vexriscv/
wget https://github.com/SpinalHDL/VexRiscv/releases/download/v1.0.0/VexRiscv.v
# Or clone and use pre-generated files
git clone https://github.com/SpinalHDL/VexRiscv
cp VexRiscv/src/main/scala/vexriscv/demo/GenFull.v ./VexRiscv.v
```

2. Verify the file:
```bash
ls -lh VexRiscv.v
# Should see a Verilog file ~50-100 KB
```

**Option B: Generate from SpinalHDL (Advanced)**

If you want to customize the ISA:

```bash
# Install SBT (Scala Build Tool)
sudo apt-get install sbt

# Clone VexRiscv
git clone https://github.com/SpinalHDL/VexRiscv
cd VexRiscv

# Generate custom configuration
sbt "runMain vexriscv.demo.GenFull"

# Copy generated Verilog
cp VexRiscv.v ../rtl/cores/vexriscv/
```

### Step 3: Generate Top-Level

```bash
# Generate top.v from default configuration
make gen

# Check generated file
cat build/generated/top.v
```

### Step 4: Create Stub RTL Modules

Since you're just starting, create empty stub modules that will be implemented later:

**Create `rtl/core/core_wrapper.v`:**
```verilog
module core_wrapper #(
    parameter CORE_ID = 0,
    parameter XLEN = 32,
    parameter ISA_STRING = "RV32I"
) (
    input wire clk,
    input wire rst_n,
    
    // Task interface (stub)
    input wire task_req,
    output wire task_ack,
    input wire [127:0] task_data,
    
    // Memory interface (stub)
    output wire mem_req,
    output wire mem_we,
    output wire [XLEN-1:0] mem_addr,
    output wire [XLEN-1:0] mem_wdata,
    input wire [XLEN-1:0] mem_rdata,
    input wire mem_ack,
    
    // Neighbor interfaces (stub)
    output wire [4:0] nbr0_reg_addr,
    input wire [XLEN-1:0] nbr0_reg_rdata,
    output wire nbr0_reg_req,
    
    output wire [4:0] nbr1_reg_addr,
    input wire [XLEN-1:0] nbr1_reg_rdata,
    output wire nbr1_reg_req,
    
    // Status
    output wire active
);

    // TODO: Implement wrapper around VexRiscv
    // For now, just tie off outputs
    assign task_ack = 1'b0;
    assign mem_req = 1'b0;
    assign mem_we = 1'b0;
    assign mem_addr = {XLEN{1'b0}};
    assign mem_wdata = {XLEN{1'b0}};
    assign nbr0_reg_addr = 5'b0;
    assign nbr0_reg_req = 1'b0;
    assign nbr1_reg_addr = 5'b0;
    assign nbr1_reg_req = 1'b0;
    assign active = 1'b0;

endmodule
```

Create similar stubs for:
- `rtl/scheduler/task_dispatcher.v`
- `rtl/interconnect/memory_arbiter.v`
- `rtl/core/neighbor_interface.v`

### Step 5: Verify Setup

```bash
# Check that all files are in place
make info

# Try to generate top-level
make gen

# Run linter to check syntax
make lint
```

## Quick Start Workflows

### Simulation Workflow

```bash
# 1. Generate top-level
make gen

# 2. Create a simple testbench (tb/tb_top.v)
# 3. Run simulation
make sim

# 4. View waveforms
make waves
```

### Synthesis Workflow

```bash
# 1. Generate top-level
make gen

# 2. Synthesize for PYNQ-Z2
make synth

# 3. Check reports in build/
ls build/*/synth-vivado/

# 4. Program FPGA (if connected)
make program
```

### Incremental Development

**Phase 1: Single Core on FPGA**
```bash
# Edit configs/default.json to NUM_CORES = 1
# Implement basic core_wrapper.v
make gen
make synth
```

**Phase 2: Multi-core without Scheduler**
```bash
# Increase NUM_CORES to 2
# Implement memory_arbiter.v
make gen
make sim
```

**Phase 3: Add Neighbor Network**
```bash
# Implement neighbor_interface.v
# Test with custom instructions
make sim
```

**Phase 4: Add Scheduler**
```bash
# Implement task_dispatcher.v
# Run benchmarks
make verify
```

## Configuration

### Changing Number of Cores

Edit `configs/default.json`:

```json
{
  "cores": {
    "num_cores": 2,  // Change this
    ...
  }
}
```

Then regenerate:
```bash
make gen
```

### Changing Topology

In `configs/default.json`:

```json
{
  "topology": {
    "type": "mesh",  // Options: "ring", "mesh", "fully_connected"
    ...
  }
}
```

### Adding Different Core Types

```json
{
  "cores": {
    "core_types": [
      {"id": 0, "isa": "RV32I", "name": "core_0"},
      {"id": 1, "isa": "RV32IM", "name": "core_1"}
    ]
  }
}
```

## Troubleshooting

### FuseSoC Can't Find Core

```bash
# Check FuseSoC library
fusesoc library list

# Add current directory
fusesoc library add coreographer .
```

### Verilator Compilation Errors

```bash
# Check generated top.v
cat build/generated/top.v

# Run lint only
make lint

# Check for syntax errors in RTL
```

### VexRiscv Not Found

```bash
# Verify file exists
ls -l rtl/cores/vexriscv/VexRiscv.v

# If missing, download from GitHub
# See Step 2 above
```

### Vivado Synthesis Fails

```bash
# Check synthesis log
cat build/*/synth-vivado/*.log

# Common issues:
# - Missing constraint file
# - Undefined modules (check stubs)
# - Timing violations (increase clock period)
```

## Next Steps

1. **Implement Core Wrapper**
   - Instantiate VexRiscv
   - Add custom instruction decoder
   - Connect memory interface

2. **Implement Memory Arbiter**
   - Round-robin or priority-based
   - Handle multiple core requests

3. **Implement Neighbor Network**
   - Register file proxy
   - Inter-core connections based on topology

4. **Implement Scheduler**
   - Task queue
   - Dependency tracking
   - Dispatch logic

5. **Create Benchmarks**
   - Vector dot product
   - Matrix multiply
   - Streaming accumulator

6. **FPGA Demo**
   - Synthesize and program
   - Add LED indicators
   - Monitor performance counters

## Useful Commands

```bash
# Clean build artifacts
make clean

# Show configuration
make info

# List all targets
make help

# Run specific testbench
make sim-core
make sim-scheduler

# Generate different configurations
CONFIG=configs/8core.json make gen

# Quick iteration: edit â†’ gen â†’ sim
make gen && make sim
```

## Resources

- **VexRiscv**: https://github.com/SpinalHDL/VexRiscv
- **FuseSoC**: https://fusesoc.readthedocs.io/
- **RISC-V Spec**: https://riscv.org/technical/specifications/
- **PYNQ Docs**: https://pynq.readthedocs.io/

## Getting Help

If you encounter issues:

1. Check this guide
2. Run `make help`
3. Check FuseSoC logs in `build/`
4. Verify all files exist with `make info`

Good luck with your project! ðŸš€
